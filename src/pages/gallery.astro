---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';

// Import all images from assets directory using Vite glob (recursive)
const imageModules = import.meta.glob<{ default: ImageMetadata }>('../assets/images/**/*.jpg', { 
  eager: true 
});

// Convert glob results to array with filenames and image metadata
const images = Object.entries(imageModules).map(([path, module]) => {
  const filename = path.split('/').pop() || '';
  // Extract directory number from path (e.g., '../assets/images/1/DSCF1088.jpg' -> '1')
  const pathParts = path.split('/');
  const directoryIndex = pathParts.indexOf('images');
  const directoryNumber = directoryIndex >= 0 && directoryIndex < pathParts.length - 1 
    ? pathParts[directoryIndex + 1] 
    : '';
  const image = module.default;
  const aspectRatio = image.width && image.height 
    ? `${image.width}/${image.height}`
    : '3/2';
  return {
    filename,
    image,
    aspectRatio,
    directoryNumber,
  };
});

// Shuffle the images
const shuffledImages = [...images].sort(() => Math.random() - 0.5);

const getDemoNightDate = (directoryNumber: string) => {
  switch (directoryNumber) {
    case '1':
      return 'August 2025';
    case '2':
      return 'November 2025';
    case '3':
      return 'February 2026';
  }
};
---

<BaseLayout title="Gallery | Demo Night">
  <div class="pl-4 columns-1 md:columns-2 lg:columns-3 xl:columns-4 gap-4 space-y-4">
    {shuffledImages.map((item) => (
      <div class="break-inside-avoid mb-4">
        <div 
          class="w-full rounded overflow-hidden"
          style={`aspect-ratio: ${item.aspectRatio};`}
          title={`Demo Night ${item.directoryNumber} (${getDemoNightDate(item.directoryNumber)})`}
        >
          <Image
            src={item.image}
            alt={item.filename}
            width={1200}
            quality={85}
            format="webp"
            class="w-full h-full object-cover"
            loading="lazy"
          />
        </div>
      </div>
    ))}
  </div>
</BaseLayout>
